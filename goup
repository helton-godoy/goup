#!/bin/bash

# goup - Gerenciador completo para Go (golang)
# Instala, atualiza e gerencia vers√µes do Go + ferramentas essenciais
# Compat√≠vel com qualquer distribui√ß√£o Linux, sem depend√™ncias de gerenciadores de pacotes
# Inclui verifica√ß√µes rigorosas, logs detalhados, tratamento de erros e testes automatizados

set -euo pipefail  # Exit on error, undefined vars, pipe failures

# Configura√ß√µes padr√£o
readonly SCRIPT_NAME="goup"
readonly SCRIPT_VERSION="1.0.0"
readonly DEFAULT_INSTALL_DIR="/usr/local/go"
readonly GO_VERSIONS_DIR="/usr/local/.go-versions"
readonly GOUP_INSTALL_DIR="/usr/local/bin/goup"
readonly LOG_FILE="/tmp/${SCRIPT_NAME}_$(date +%Y%m%d_%H%M%S).log"
readonly TEMP_DIR="./tmp/${SCRIPT_NAME}_install_$$"

# Cores para output (se suportado)
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m'  # No Color

# Fun√ß√£o de logging
log() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "[$timestamp] [$level] $message" | tee -a "$LOG_FILE"
}

# Fun√ß√£o de erro
error() {
    log "ERROR" "${RED}$1${NC}"
    echo -e "${RED}Erro: $1${NC}" >&2
    cleanup
    exit "${2:-1}"
}

# Fun√ß√£o de sucesso
success() {
    log "INFO" "${GREEN}$1${NC}"
    echo -e "${GREEN}$1${NC}"
}

# Fun√ß√£o de aviso
warn() {
    log "WARN" "${YELLOW}$1${NC}"
    echo -e "${YELLOW}Aviso: $1${NC}"
}

# Fun√ß√£o de limpeza
cleanup() {
    log "INFO" "Executando limpeza..."
    if [[ -d "$TEMP_DIR" ]]; then
        rm -rf "$TEMP_DIR"
        log "INFO" "Diret√≥rio tempor√°rio removido: $TEMP_DIR"
    fi
    if [[ -n "${temp_file:-}" ]] && [[ -f "$temp_file" ]]; then
        rm -f "$temp_file"
        log "INFO" "Arquivo tempor√°rio removido: $temp_file"
    fi
}

# Trap para limpeza em caso de interrup√ß√£o
trap cleanup SIGINT SIGTERM EXIT

# Verifica√ß√£o de depend√™ncias
check_dependencies() {
    log "INFO" "Verificando depend√™ncias do sistema..."

    local deps=("curl" "tar" "grep" "uname" "sha256sum")
    local missing_deps=()

    for dep in "${deps[@]}"; do
        if ! command -v "$dep" >/dev/null 2>&1; then
            missing_deps+=("$dep")
        fi
    done

    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        error "Depend√™ncias faltantes: ${missing_deps[*]}. Instale-as manualmente." 2
    fi

    success "Todas as depend√™ncias est√£o presentes."
}

# Detec√ß√£o de arquitetura
detect_arch() {
    local arch=$(uname -m)
    case "$arch" in
        x86_64) echo "amd64" ;;
        aarch64|arm64) echo "arm64" ;;
        i386|i686) echo "386" ;;
        *) error "Arquitetura n√£o suportada: $arch" 3 ;;
    esac
}

# Detec√ß√£o de vers√£o mais recente
get_latest_version() {
    local arch="$1"
    log "INFO" "Buscando vers√£o mais recente do Go para arquitetura $arch..."

    local html
    if ! html=$(curl -sL --max-time 30 https://golang.org/dl/); then
        error "Falha ao acessar https://golang.org/dl/" 4
    fi

    local version
    version=$(echo "$html" | grep -oP "go[0-9]+\.[0-9]+(\.[0-9]+)?\.linux-$arch\.tar\.gz" | head -n 1 | sed 's/\.linux-.*\.tar\.gz//' | tr -d '\n\r')

    if [[ -z "$version" ]]; then
        error "N√£o foi poss√≠vel encontrar vers√£o do Go para arquitetura $arch" 5
    fi

    log "INFO" "Vers√£o encontrada: $version"
    echo "$version"
}

# Download com verifica√ß√£o de checksum
download_go() {
    local version="$1"
    local arch="$2"
    local url="https://golang.org/dl/${version}.linux-${arch}.tar.gz"
    local checksum_url="${url}.sha256"

    log "INFO" "Baixando Go de: $url"
    log "INFO" "Arquivo tempor√°rio: $temp_file"

    if ! curl -L --max-time 300 --progress-bar "$url" -o "$temp_file"; then
        error "Falha no download do arquivo Go" 6
    fi

    log "INFO" "Verificando checksum..."
    local expected_checksum
    if ! expected_checksum=$(curl -sL --max-time 30 "$checksum_url" 2>/dev/null | grep -o '[a-f0-9]\{64\}' | head -1); then
        warn "N√£o foi poss√≠vel obter checksum oficial. Pulando verifica√ß√£o."
    else
        local actual_checksum
        actual_checksum=$(sha256sum "$temp_file" | cut -d' ' -f1)
        if [[ "$actual_checksum" != "$expected_checksum" ]]; then
            error "Checksum do arquivo n√£o corresponde. Download possivelmente corrompido." 7
        fi
        success "Checksum verificado com sucesso."
    fi
}

# Verifica√ß√£o de permiss√µes
check_permissions() {
    local install_dir="$1"
    log "INFO" "Verificando permiss√µes para instala√ß√£o em $install_dir"

    if [[ ! -w "$(dirname "$install_dir")" ]]; then
        error "Sem permiss√µes de escrita em $(dirname "$install_dir"). Execute como root ou especifique --install-dir." 8
    fi

    success "Permiss√µes adequadas confirmadas."
}

# Instala√ß√£o
install_go() {
    local install_dir="$1"
    local version="$2"
    log "INFO" "Instalando Go $version em $install_dir"

    # Verifica se j√° existe uma instala√ß√£o
    if [[ -d "$install_dir" ]]; then
        log "WARN" "J√° existe uma instala√ß√£o do Go em $install_dir"

        # Tenta obter vers√£o atual
        local current_version=""
        if [[ -x "$install_dir/bin/go" ]]; then
            current_version=$("$install_dir/bin/go" version 2>/dev/null | grep -oP 'go[0-9]+\.[0-9]+(\.[0-9]+)?' || true)
        fi

        if [[ -n "$current_version" ]]; then
            log "INFO" "Vers√£o atual instalada: $current_version"
        fi

        # Pergunta ao usu√°rio o que fazer
        echo ""
        echo "J√° existe uma instala√ß√£o do Go em $install_dir"
        if [[ -n "$current_version" ]]; then
            echo "Vers√£o atual: $current_version"
        fi
        echo ""
        echo "Escolha uma op√ß√£o:"
        echo "1) Substituir a instala√ß√£o existente (recomendado)"
        echo "2) Manter ambas as vers√µes (instalar em diret√≥rio de vers√µes)"
        echo "3) Cancelar instala√ß√£o"
        echo ""

        local choice
        read -p "Digite sua escolha (1-3): " choice

        case "$choice" in
            1)
                log "INFO" "Removendo instala√ß√£o anterior..."
                rm -rf "$install_dir"
                ;;
            2)
                # Move vers√£o atual para diret√≥rio de vers√µes
                if [[ -n "$current_version" ]]; then
                    local versions_dir="$GO_VERSIONS_DIR"
                    mkdir -p "$versions_dir"
                    local versioned_dir="$versions_dir/$current_version"
                    log "INFO" "Movendo vers√£o atual para $versioned_dir"
                    mv "$install_dir" "$versioned_dir"
                else
                    # Remove instala√ß√£o sem vers√£o identificada
                    rm -rf "$install_dir"
                fi

                # Instala nova vers√£o no diret√≥rio padr√£o
                log "INFO" "Instalando nova vers√£o no diret√≥rio padr√£o"
                ;;
            3)
                log "INFO" "Instala√ß√£o cancelada pelo usu√°rio"
                cleanup
                exit 0
                ;;
            *)
                error "Escolha inv√°lida. Instala√ß√£o cancelada." 13
                ;;
        esac
    fi

    # Cria diret√≥rio pai se necess√°rio
    mkdir -p "$(dirname "$install_dir")"

    # Extrai
    log "INFO" "Extraindo arquivo para $(dirname "$install_dir")"
    if ! tar -C "$(dirname "$install_dir")" -xzf "$temp_file"; then
        error "Falha ao extrair arquivo Go" 9
    fi

    success "Go $version instalado com sucesso em $install_dir"
}

# Configura√ß√£o do PATH
configure_path() {
    local install_dir="$1"
    local bashrc="$HOME/.bashrc"
    local profile="$HOME/.profile"

    log "INFO" "Configurando PATH..."

    local path_line="export PATH=\$PATH:$install_dir/bin"

    # Adiciona ao .bashrc se n√£o existir
    if [[ -f "$bashrc" ]] && ! grep -q "$path_line" "$bashrc"; then
        echo "$path_line" >> "$bashrc"
        log "INFO" "PATH adicionado ao $bashrc"
    fi

    # Adiciona ao .profile se n√£o existir
    if [[ -f "$profile" ]] && ! grep -q "$path_line" "$profile"; then
        echo "$path_line" >> "$profile"
        log "INFO" "PATH adicionado ao $profile"
    fi

    # Define PATH para sess√£o atual
    export PATH="$PATH:$install_dir/bin"
    success "PATH configurado. Execute 'source ~/.bashrc' ou reinicie o terminal."
}


# Valida√ß√£o da instala√ß√£o
validate_installation() {
    local install_dir="$1"
    local expected_version="$2"

    log "INFO" "Validando instala√ß√£o..."

    if [[ ! -x "$install_dir/bin/go" ]]; then
        error "Execut√°vel go n√£o encontrado em $install_dir/bin" 10
    fi

    local installed_version
    installed_version=$("$install_dir/bin/go" version 2>/dev/null | grep -oP 'go[0-9]+\.[0-9]+(\.[0-9]+)?' || true)

    if [[ -z "$installed_version" ]]; then
        error "N√£o foi poss√≠vel obter vers√£o do Go instalado" 11
    fi

    if [[ "$installed_version" != "$expected_version" ]]; then
        warn "Vers√£o instalada ($installed_version) difere da esperada ($expected_version)"
    else
        success "Vers√£o validada: $installed_version"
    fi
}

# Instalar ferramentas essenciais do Go
install_tools() {
    local install_dir="$1"
    log "INFO" "Instalando ferramentas essenciais do Go..."

    local tools=(
        "golang.org/x/tools/cmd/goimports@latest"
        "honnef.co/go/tools/cmd/staticcheck@latest"
        "github.com/cosmtrek/air@latest"
        "github.com/go-delve/delve/cmd/dlv@latest"
    )

    for tool in "${tools[@]}"; do
        log "INFO" "Instalando $tool"
        if ! "$install_dir/bin/go" install "$tool" >/dev/null 2>&1; then
            warn "Falha ao instalar $tool"
        else
            success "Instalado: $tool"
        fi
    done

    # Instalar golangci-lint separadamente (n√£o √© um bin√°rio Go)
    log "INFO" "Instalando golangci-lint..."
    if command -v curl >/dev/null 2>&1; then
        curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b "$install_dir/bin" v1.55.2 >/dev/null 2>&1 && success "golangci-lint instalado" || warn "Falha ao instalar golangci-lint"
    else
        warn "curl n√£o dispon√≠vel, pulando golangci-lint"
    fi
}

# Testes automatizados
run_tests() {
    log "INFO" "Executando testes automatizados..."

    # Cria projeto de teste tempor√°rio
    local test_dir="$TEMP_DIR/test_project"
    mkdir -p "$test_dir"
    cd "$test_dir"

    # Inicializa m√≥dulo
    if ! "$install_dir/bin/go" mod init test >/dev/null 2>&1; then
        warn "Falha ao inicializar m√≥dulo de teste"
        return
    fi

    # Cria arquivo de teste simples
    cat > main_test.go << 'EOF'
package main

import "testing"

func TestExample(t *testing.T) {
    if 1+1 != 2 {
        t.Error("Matem√°tica b√°sica falhou")
    }
}
EOF

    # Executa testes
    if "$install_dir/bin/go" test -v -race . >/dev/null 2>&1; then
        success "Testes automatizados passaram"
    else
        warn "Alguns testes falharam. Verifique manualmente com 'go test -v -race'"
    fi

    cd - >/dev/null
}

# Auto-instala√ß√£o do goup
self_install() {
    log "INFO" "Instalando goup em $GOUP_INSTALL_DIR"

    # Cria diret√≥rio se necess√°rio
    mkdir -p "$(dirname "$GOUP_INSTALL_DIR")"

    # Copia o script para o local do sistema
    cp "$0" "$GOUP_INSTALL_DIR"
    chmod +x "$GOUP_INSTALL_DIR"

    success "goup instalado em $GOUP_INSTALL_DIR"
    echo ""
    echo "Agora voc√™ pode usar 'goup' de qualquer lugar!"
    echo "Exemplos:"
    echo "  goup --help          # Ver ajuda"
    echo "  goup --list          # Listar vers√µes"
    echo "  goup --switch go1.21.5  # Alternar vers√£o"
    echo "  goup --update-tools  # Atualizar ferramentas"
}

# Listar vers√µes instaladas
list_versions() {
    local versions_dir="$GO_VERSIONS_DIR"
    if [[ -d "$versions_dir" ]]; then
        echo "Vers√µes instaladas em $versions_dir:"
        ls -1 "$versions_dir" | while read -r version_dir; do
            if [[ -d "$versions_dir/$version_dir" && -x "$versions_dir/$version_dir/bin/go" ]]; then
                local ver=$("$versions_dir/$version_dir/bin/go" version 2>/dev/null | grep -oP 'go[0-9]+\.[0-9]+(\.[0-9]+)?' || echo "desconhecida")
                echo "  $version_dir ($ver)"
            fi
        done
    else
        echo "Nenhuma vers√£o adicional instalada."
    fi

    # Verifica vers√£o padr√£o
    if [[ -d "$DEFAULT_INSTALL_DIR" && -x "$DEFAULT_INSTALL_DIR/bin/go" ]]; then
        local default_ver=$("$DEFAULT_INSTALL_DIR/bin/go" version 2>/dev/null | grep -oP 'go[0-9]+\.[0-9]+(\.[0-9]+)?' || echo "desconhecida")
        echo ""
        echo "Vers√£o padr√£o: $default_ver ($DEFAULT_INSTALL_DIR)"
    fi
}

# Alternar vers√£o padr√£o
switch_version() {
    local target_version="$1"
    local versions_dir="$GO_VERSIONS_DIR"
    local target_dir="$versions_dir/$target_version"

    if [[ ! -d "$target_dir" ]]; then
        error "Vers√£o $target_version n√£o encontrada em $versions_dir" 14
    fi

    log "INFO" "Alternando para vers√£o $target_version"

    # Backup da vers√£o atual se existir
    if [[ -d "$DEFAULT_INSTALL_DIR" ]]; then
        local current_ver=""
        if [[ -x "$DEFAULT_INSTALL_DIR/bin/go" ]]; then
            current_ver=$("$DEFAULT_INSTALL_DIR/bin/go" version 2>/dev/null | grep -oP 'go[0-9]+\.[0-9]+(\.[0-9]+)?' || echo "unknown")
        fi
        if [[ -n "$current_ver" && "$current_ver" != "$target_version" ]]; then
            local backup_dir="$versions_dir/$current_ver"
            mkdir -p "$versions_dir"
            log "INFO" "Fazendo backup da vers√£o atual $current_ver"
            mv "$DEFAULT_INSTALL_DIR" "$backup_dir"
        else
            rm -rf "$DEFAULT_INSTALL_DIR"
        fi
    fi

    # Cria link simb√≥lico ou move para diret√≥rio padr√£o
    mkdir -p "$(dirname "$DEFAULT_INSTALL_DIR")"
    mv "$target_dir" "$DEFAULT_INSTALL_DIR"

    success "Vers√£o padr√£o alterada para $target_version"
    configure_path "$DEFAULT_INSTALL_DIR"
}

# Fun√ß√£o principal
main() {
    local install_dir="$DEFAULT_INSTALL_DIR"
    local version=""
    local arch=""
    local install_tools_flag=false
    local self_install_flag=false

    # Parsing de argumentos
    while [[ $# -gt 0 ]]; do
        case $1 in
            --version)
                version="$2"
                shift 2
                ;;
            --install-dir)
                install_dir="$2"
                shift 2
                ;;
            --install-tools)
                install_tools_flag=true
                shift
                ;;
            --self-install)
                self_install_flag=true
                shift
                ;;
            --list)
                list_versions
                exit 0
                ;;
            --switch)
                switch_version "$2"
                exit 0
                ;;
            --update-tools)
                if [[ -d "$DEFAULT_INSTALL_DIR" && -x "$DEFAULT_INSTALL_DIR/bin/go" ]]; then
                    install_tools "$DEFAULT_INSTALL_DIR"
                    success "Ferramentas atualizadas!"
                else
                    error "Go n√£o est√° instalado. Instale primeiro com: $0" 15
                fi
                exit 0
                ;;
            --help)
                echo "goup - Gerenciador completo para Go"
                echo ""
                echo "Uso: $0 [--version VERSION] [--install-dir DIR] [OP√á√ïES]"
                echo ""
                echo "Instala√ß√£o:"
                echo "  --version VERSION     Vers√£o espec√≠fica do Go (ex: go1.21.0)"
                echo "  --install-dir DIR     Diret√≥rio de instala√ß√£o (padr√£o: $DEFAULT_INSTALL_DIR)"
                echo "  --install-tools       Instalar ferramentas essenciais ap√≥s Go"
                echo "  --self-install        Instalar goup no sistema (/usr/local/bin/goup)"
                echo ""
                echo "Gerenciamento:"
                echo "  --list                Listar vers√µes instaladas"
                echo "  --switch VERSION      Alternar vers√£o padr√£o (ex: go1.21.5)"
                echo "  --update-tools        Atualizar ferramentas essenciais"
                echo ""
                echo "Exemplos:"
                echo "  $0                           # Instalar vers√£o mais recente"
                echo "  $0 --version go1.21.5        # Instalar vers√£o espec√≠fica"
                echo "  $0 --install-tools           # Instalar com ferramentas"
                echo "  $0 --self-install            # Auto-instalar goup"
                echo "  $0 --list                    # Listar vers√µes"
                echo "  $0 --switch go1.21.5         # Alternar vers√£o"
                exit 0
                ;;
            *)
                error "Argumento desconhecido: $1. Use --help para ver op√ß√µes dispon√≠veis." 12
                ;;
        esac
    done

    # Se for apenas auto-instala√ß√£o
    if [[ "$self_install_flag" == true && $# -eq 1 ]]; then
        self_install
        exit 0
    fi

    log "INFO" "Iniciando instala√ß√£o do Go com goup v$SCRIPT_VERSION"
    log "INFO" "Log salvo em: $LOG_FILE"

    check_dependencies

    arch=$(detect_arch)
    log "INFO" "Arquitetura detectada: $arch"

    if [[ -z "$version" ]]; then
        version=$(get_latest_version "$arch")
    else
        log "INFO" "Usando vers√£o especificada: $version"
    fi

    temp_file="$TEMP_DIR/${version}.linux-${arch}.tar.gz"
    mkdir -p "$TEMP_DIR"

    check_permissions "$install_dir"
    download_go "$version" "$arch"
    install_go "$install_dir" "$version"
    configure_path "$install_dir"
    validate_installation "$install_dir" "$version"
    run_tests

    # Instalar ferramentas se solicitado
    if [[ "$install_tools_flag" == true ]]; then
        install_tools "$install_dir"
    fi

    # Auto-instalar goup se solicitado
    if [[ "$self_install_flag" == true ]]; then
        self_install
    fi

    success "Instala√ß√£o do Go $version conclu√≠da com sucesso!"
    echo ""
    echo "üöÄ Go $version est√° pronto para uso!"
    echo ""
    echo "Para ativar na sess√£o atual:"
    echo "  source ~/.bashrc"
    echo ""
    echo "Para verificar:"
    echo "  go version"
    echo ""
    echo "Para gerenciar vers√µes:"
    echo "  goup --list                    # Listar vers√µes"
    echo "  goup --switch go1.21.5         # Alternar vers√£o"
    echo "  goup --update-tools            # Atualizar ferramentas"
    echo ""
    if [[ "$install_tools_flag" == false ]]; then
        echo "üí° Dica: Use --install-tools na pr√≥xima instala√ß√£o para incluir ferramentas essenciais!"
    fi
    echo ""
    echo "Log detalhado dispon√≠vel em: $LOG_FILE"
}

# Executa fun√ß√£o principal
main "$@"
